services:
  zookeeper:
    image: bitnami/zookeeper:3.9
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports: ["2181:2181"]

  kafka:
    image: bitnami/kafka:3.7
    depends_on: [zookeeper]
    ports: ["9092:9092"]
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092

  ticketdb:
    image: postgres:16-alpine
    container_name: ticketdb
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=tickets
    ports: ["5432:5432"]
    volumes:
      - ./sql:/sql

  passenger_service:
    image: ballerina/ballerina:latest
    working_dir: /app
    volumes:
      - ./passenger_service:/app/svc
    command: ["bal","run","/app/svc"]
    environment:
      - DB_USER=postgres
      - DB_PASS=postgres
    depends_on: [ticketdb]
    ports: ["8081:8081"]

  ticketing_service:
    image: ballerina/ballerina:latest
    working_dir: /app
    volumes:
      - ./ticketing_service:/app/svc
    command: ["bal","run","/app/svc"]
    environment:
      - KAFKA_HOST=kafka:9092
      - DB_USER=postgres
      - DB_PASS=postgres
    depends_on: [kafka, ticketdb]
    ports: ["8082:8082"]

  payment_service:
    image: ballerina/ballerina:latest
    working_dir: /app
    volumes:
      - ./payment_service:/app/svc
    command: ["bal","run","/app/svc"]
    environment:
      - KAFKA_HOST=kafka:9092
    depends_on: [kafka]

  transport_service:
    image: ballerina/ballerina:latest
    working_dir: /app
    volumes:
      - ./transport_service:/app/svc
    command: ["bal","run","/app/svc"]
    environment:
      - KAFKA_HOST=kafka:9092
      - DB_USER=postgres
      - DB_PASS=postgres
    depends_on: [kafka, ticketdb]
    ports: ["8083:8083"]

  notification_service:
    image: ballerina/ballerina:latest
    working_dir: /app
    volumes:
      - ./notification_service:/app/svc
    command: ["bal","run","/app/svc"]
    environment:
      - KAFKA_HOST=kafka:9092
    depends_on: [kafka]
    ports: ["8084:8084"]
